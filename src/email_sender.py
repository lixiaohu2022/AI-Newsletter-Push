"""
é‚®ä»¶å‘é€æ¨¡å—
ä½¿ç”¨Gmail SMTPå‘é€HTMLé‚®ä»¶
"""

import os
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime
from typing import List, Dict, Any
from jinja2 import Environment, FileSystemLoader


class EmailSender:
    """é‚®ä»¶å‘é€ç±»"""

    def __init__(self, template_dir: str = 'templates'):
        """
        åˆå§‹åŒ–é‚®ä»¶å‘é€å™¨

        Args:
            template_dir: æ¨¡æ¿æ–‡ä»¶ç›®å½•
        """
        self.smtp_server = "smtp.gmail.com"
        self.smtp_port = 587
        self.sender_email = os.getenv('GMAIL_SENDER')
        self.sender_password = os.getenv('GMAIL_APP_PASSWORD')

        if not self.sender_email or not self.sender_password:
            raise ValueError("GMAIL_SENDER and GMAIL_APP_PASSWORD environment variables are required")

        # è®¾ç½®Jinja2æ¨¡æ¿ç¯å¢ƒ
        self.template_env = Environment(loader=FileSystemLoader(template_dir))

    def render_newsletter(self, categories: List[Dict[str, Any]]) -> str:
        """
        æ¸²æŸ“æ–°é—»ç®€æŠ¥HTML

        Args:
            categories: åˆ†ç±»æ–°é—»æ•°æ®

        Returns:
            æ¸²æŸ“åçš„HTMLå­—ç¬¦ä¸²
        """
        template = self.template_env.get_template('newsletter.html')

        return template.render(
            date=datetime.now().strftime('%Y-%m-%d %A'),
            categories=categories
        )

    def send_newsletter(self, recipient: str, subject: str,
                       categories: List[Dict[str, Any]], sender_name: str = "AI News Bot") -> bool:
        """
        å‘é€æ–°é—»ç®€æŠ¥é‚®ä»¶

        Args:
            recipient: æ”¶ä»¶äººé‚®ç®±
            subject: é‚®ä»¶ä¸»é¢˜
            categories: åˆ†ç±»æ–°é—»æ•°æ®
            sender_name: å‘ä»¶äººåç§°

        Returns:
            å‘é€æ˜¯å¦æˆåŠŸ
        """
        try:
            # æ¸²æŸ“HTMLå†…å®¹
            html_content = self.render_newsletter(categories)

            # åˆ›å»ºé‚®ä»¶
            message = MIMEMultipart('alternative')
            message['Subject'] = subject
            message['From'] = f"{sender_name} <{self.sender_email}>"
            message['To'] = recipient

            # åˆ›å»ºçº¯æ–‡æœ¬ç‰ˆæœ¬ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            text_content = self._create_text_version(categories)
            part1 = MIMEText(text_content, 'plain', 'utf-8')
            part2 = MIMEText(html_content, 'html', 'utf-8')

            message.attach(part1)
            message.attach(part2)

            # å‘é€é‚®ä»¶
            print(f"Connecting to SMTP server: {self.smtp_server}:{self.smtp_port}")
            with smtplib.SMTP(self.smtp_server, self.smtp_port) as server:
                server.starttls()
                print(f"Logging in as: {self.sender_email}")
                server.login(self.sender_email, self.sender_password)
                print(f"Sending email to: {recipient}")
                server.send_message(message)

            print(f"Newsletter sent successfully to {recipient}")
            return True

        except Exception as e:
            print(f"Failed to send email: {e}")
            return False

    def _create_text_version(self, categories: List[Dict[str, Any]]) -> str:
        """
        åˆ›å»ºé‚®ä»¶çš„çº¯æ–‡æœ¬ç‰ˆæœ¬

        Args:
            categories: åˆ†ç±»æ–°é—»æ•°æ®

        Returns:
            çº¯æ–‡æœ¬å†…å®¹
        """
        text_parts = [
            "AI WEEKLY NEWSLETTER - äººå·¥æ™ºèƒ½å‘¨æŠ¥",
            "=" * 60,
            f"Date: {datetime.now().strftime('%Y-%m-%d %A')}",
            "=" * 60,
            ""
        ]

        for category in categories:
            text_parts.append(f"\n## {category['category_name_en']}")
            text_parts.append(f"## {category['category_name_zh']}")
            text_parts.append("-" * 60)

            for i, item in enumerate(category['news_items'], 1):
                text_parts.append(f"\n{i}. {item['title']}")
                text_parts.append(f"   URL: {item['url']}")
                text_parts.append(f"   EN: {item['summary_en']}")
                text_parts.append(f"   ä¸­æ–‡: {item['summary_zh']}")
                if item.get('significance'):
                    text_parts.append(f"   ğŸ’¡ {item['significance']}")
                text_parts.append("")

        text_parts.append("\n" + "=" * 60)
        text_parts.append("Automatically generated by AI News Bot")
        text_parts.append("æœ¬ç®€æŠ¥ç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œæ¯å‘¨ä¸€ä¸Šåˆ9:00å‘é€")

        return "\n".join(text_parts)
